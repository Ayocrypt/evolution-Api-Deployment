services:
  # Evolution API Backend (using pre-built Docker image)
  - type: web
    name: evolution-api
    runtime: image
    image:
      url: evoapicloud/evolution-api:latest
    envVars:
      - key: SERVER_TYPE
        value: http
      - key: SERVER_PORT
        value: 8080
      - key: SERVER_URL
        sync: false
      - key: CORS_ORIGIN
        value: "*"
      - key: AUTHENTICATION_API_KEY
        sync: false
      - key: CACHE_REDIS_ENABLED
        value: "true"
      - key: CACHE_REDIS_URI
        fromService:
          type: keyvalue
          name: evolution-redis
          property: connectionString
      - key: DATABASE_ENABLED
        value: "true"
      - key: DATABASE_PROVIDER
        value: postgresql
      - key: DATABASE_CONNECTION_URI
        fromDatabase:
          name: evolution-postgres
          property: connectionString
      - key: DATABASE_CONNECTION_CLIENT_NAME
        value: evolution_exchange
      - key: LOG_LEVEL
        value: ERROR,WARN,INFO
      - key: LOG_COLOR
        value: "true"
    healthCheckPath: /health
    numInstances: 1

  # Manager UI (build from source)
  - type: web
    name: evolution-manager
    runtime: docker
    dockerfilePath: ./evolution-manager-v2/Dockerfile
    dockerContext: ./evolution-manager-v2
    envVars:
      - key: NODE_ENV
        value: production
    numInstances: 1

  # Redis Cache
  - type: keyvalue
    name: evolution-redis
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList:
      - source: 0.0.0.0/0
        description: everywhere

databases:
  # PostgreSQL Database
  - name: evolution-postgres
    databaseName: postgres
    user: postgres
    plan: free
